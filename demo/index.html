<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1" />
    <title>Void and Cluster demo</title>
    <style>
      textarea {
        width: 200px;
        height: 100px;
        font-family: "Courier New", Courier, monospace;
      }
    </style>
  </head>
  <body style="gap: 8px; background-color: black; color: white; display: flex; flex-direction: column; align-items: flex-start">
    <canvas id="blueNoiseCanvas" style="border: 3px solid #ff0; image-rendering: pixelated"></canvas>
    <div>
      <span>Algorithm</span>
      <select id="blueNoiseAlgo">
        <option value="VACluster">Void and Cluster</option>
        <option value="georgievFajardo">Georgiev-Fajardo(Relaxation)</option>
      </select>
    </div>
    <div>
      <span>Width</span>
      <input type="number" id="blueNoiseWidth" value="64" />
    </div>
    <div>
      <span>Height</span>
      <input type="number" id="blueNoiseHeight" value="64" />
    </div>
    <div>
      <span>Initial sigma scale</span>
      <input type="number" id="blueNoiseInitialSigmaScale" value="0.3" />
    </div>
    <div>
      <span>Sigma(Image)</span>
      <input type="number" id="blueNoiseSigmaImage" value="2" />
    </div>
    <div>
      <span>Sigma sample</span>
      <input type="number" id="blueNoiseSigmaSample" value="0.1" />
    </div>
    <div>
      <span>Density</span>
      <input type="number" id="blueNoiseDensity" value="0.01" />
    </div>
    <div>
      <span>Iterations</span>
      <input type="number" id="blueNoiseIterations" value="500000" />
    </div>
    <div>
      <span>Candidate filling ratio</span>
      <input type="number" id="blueNoiseCandidateFillingRatio" value="0.5" />
    </div>
    <button onclick="setTimeout(blueNoiseWrapper, 0)">generate</button>
    <span id="generateTime"></span>
  </body>
  <script src="../src/blue-noise-utils.js"></script>
  <script src="../src/blue-noise-float16.js"></script>
  <script src="../src/blue-noise-float32.js"></script>
  <script src="../src/blue-noise-float64.js"></script>
  <script>
    var blueNoiseCanvas = document.getElementById("blueNoiseCanvas");
    var blueNoiseCtx = blueNoiseCanvas.getContext("2d");
    document.getElementById("gotoVariableVACluster").addEventListener("click", function () {
      window.location.href = "variable-blue-noise/";
    });

    function findHighest(matrix) {
      let result = 0;
      const matrixLength = matrix.length;

      for (let i = 0; i < matrixLength; i++) {
        const v = matrix[i];
        if (v > result) result = v;
      }

      return result;
    }

    function blueNoiseWrapper() {
      const blueNoiseWidth = Number(document.getElementById("blueNoiseWidth").value);
      const blueNoiseHeight = Number(document.getElementById("blueNoiseHeight").value);
      blueNoiseCanvas.width = blueNoiseWidth;
      blueNoiseCanvas.height = blueNoiseHeight;
      const sqSz = blueNoiseWidth * blueNoiseHeight;
      const t0 = performance.now();
      let result;

      if (document.getElementById("blueNoiseAlgo").value === "VACluster") {
        result = blueNoiseFloat32.extendedVoidAndCluster(
          blueNoiseWidth,
          blueNoiseHeight,
          Number(document.getElementById("blueNoiseSigmaImage").value),
          Number(document.getElementById("blueNoiseInitialSigmaScale").value),
          null,
          Number(document.getElementById("blueNoiseDensity").value),
          Number(document.getElementById("blueNoiseCandidateFillingRatio").value),
          null
        );
      } else if (document.getElementById("blueNoiseAlgo").value === "georgievFajardo") {
        result = new Float32Array(sqSz);

        for (let i = 0; i < sqSz; i++) result[i] = Math.floor(Math.random() * sqSz);

        blueNoiseFloat32.georgievFajardoInPlace(
          result,
          blueNoiseWidth,
          blueNoiseHeight,
          Number(document.getElementById("blueNoiseSigmaImage").value),
          Number(document.getElementById("blueNoiseSigmaSample").value),
          Number(document.getElementById("blueNoiseIterations").value)
        );
      }

      generateTime.innerHTML = "Generating took " + (performance.now() - t0) + "ms";
      const frame = blueNoiseCtx.getImageData(0, 0, blueNoiseWidth, blueNoiseHeight);
      const imageData = frame.data;
      const sqSz4 = sqSz * 4;
      const denom = (1 / findHighest(result)) * 255; // Easier to debug with binary array...

      for (let i = 0; i < sqSz4; i += 4) imageData[i + 3] = 255;

      for (let y = 0; y < blueNoiseHeight; y++) {
        const yOffs = y * blueNoiseWidth;
        for (let x = 0; x < blueNoiseWidth; x++) {
          let i = yOffs + x;
          const v = Math.floor(result[i] * denom);
          i <<= 2;
          imageData[i] = v;
          imageData[i + 1] = v;
          imageData[i + 2] = v;
        }
      }

      blueNoiseCtx.putImageData(frame, 0, 0);
    }
  </script>
</html>
